@page "/orders/{OrderId:guid}"
@inject IOrderApiClient OrderApi
@inject IBookApiClient BookApi
@inject NavigationManager Navigation

<PageTitle>Order Details - BookStore</PageTitle>

<div class="container-fluid py-4">
    <div class="mb-4">
        <button class="btn btn-outline-secondary" @onclick="GoBack">
            <i class="bi bi-arrow-left me-2"></i>Back to Orders
        </button>
    </div>

    @if (!string.IsNullOrEmpty(_message))
    {
        <div class="alert @(_isError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
            <i class="bi @(_isError ? "bi-exclamation-triangle" : "bi-check-circle") me-2"></i>
            @_message
            <button type="button" class="btn-close" @onclick="ClearMessage" aria-label="Close"></button>
        </div>
    }

    @if (_isLoading)
    {
        <div class="d-flex justify-content-center align-items-center" style="min-height: 300px;">
            <div class="text-center">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading order details...</p>
            </div>
        </div>
    }
    else if (_order == null)
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
                <h4 class="mt-3 text-muted">Order Not Found</h4>
                <p class="text-muted">The requested order could not be found.</p>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-bottom py-3">
                        <span class="fw-semibold" style="color: #2c3e50;">
                            <i class="bi bi-info-circle me-2"></i>Order Summary
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="text-muted small">Address</label>
                            <p class="mb-0 fw-semibold">@_order.Address</p>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Created</label>
                            <p class="mb-0">@_order.DisplayCreationDate</p>
                        </div>
                        <div>
                            <label class="text-muted small">Total Cost</label>
                            <p class="mb-0 fs-4 fw-bold" style="color: #27ae60;">@_order.DisplayTotalCost</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8 mb-4">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <span class="fw-semibold" style="color: #2c3e50;">
                            <i class="bi bi-plus-circle me-2"></i>Add Book to Order
                        </span>
                    </div>
                    <div class="card-body">
                        @if (_availableBooks == null || !_availableBooks.Any())
                        {
                            <p class="text-muted mb-0">No books with available copies found.</p>
                        }
                        else
                        {
                            <EditForm Model="_addBookModel" OnValidSubmit="AddBook">
                                <DataAnnotationsValidator />
                                <div class="row align-items-end g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Select Book</label>
                                        <InputSelect @bind-Value="_addBookModel.BookId" class="form-select">
                                            <option value="@Guid.Empty">-- Select a book --</option>
                                            @foreach (var book in _availableBooks)
                                            {
                                                <option value="@book.Id">@book.Title (@book.NumberOfCopies available)</option>
                                            }
                                        </InputSelect>
                                        <ValidationMessage For="@(() => _addBookModel.BookId)" class="text-danger small" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Quantity</label>
                                        <InputNumber @bind-Value="_addBookModel.Quantity" class="form-control" min="1" />
                                        <ValidationMessage For="@(() => _addBookModel.Quantity)" class="text-danger small" />
                                    </div>
                                    <div class="col-md-3">
                                        <button type="submit" class="btn btn-success w-100" disabled="@_isAdding">
                                            @if (_isAdding)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                            }
                                            <i class="bi bi-plus-lg me-1"></i>Add
                                        </button>
                                    </div>
                                </div>
                            </EditForm>
                        }
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom py-3">
                        <span class="fw-semibold" style="color: #2c3e50;">
                            <i class="bi bi-book me-2"></i>Order Books (@_orderBooks.Count())
                        </span>
                    </div>
                    @if (!_orderBooks.Any())
                    {
                        <div class="card-body text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3 text-muted">No Books Added</h5>
                            <p class="text-muted mb-0">Add books to this order using the form above.</p>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 align-middle">
                                <thead style="background-color: #f8f9fa;">
                                    <tr>
                                        <th class="py-3 px-3">Book Title</th>
                                        <th class="py-3 text-center text-nowrap">Quantity</th>
                                        <th class="py-3 text-end text-nowrap">Price</th>
                                        <th class="py-3 text-end text-nowrap">Subtotal</th>
                                        <th class="py-3 text-center text-nowrap">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var book in _orderBooks)
                                    {
                                        <tr>
                                            <td class="px-3 fw-semibold" style="color: #2c3e50;">
                                                @book.BookTitle
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-secondary">@book.Quantity</span>
                                            </td>
                                            <td class="text-end text-muted">
                                                @book.DisplayPrice
                                            </td>
                                            <td class="text-end fw-semibold" style="color: #27ae60;">
                                                @book.DisplaySubtotal
                                            </td>
                                            <td class="text-center">
                                                <button class="btn btn-outline-danger btn-sm" @onclick="() => RemoveBook(book.BookId)" title="Remove from order">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot style="background-color: #f8f9fa;">
                                    <tr>
                                        <th colspan="3" class="px-3 py-3 text-end">Total:</th>
                                        <th class="py-3 text-end fw-bold" style="color: #27ae60;">@_order.DisplayTotalCost</th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid OrderId { get; set; }

    private OrderViewModel? _order;
    private IEnumerable<OrderBookViewModel> _orderBooks = Enumerable.Empty<OrderBookViewModel>();
    private IEnumerable<BookViewModel>? _availableBooks;
    private AddBookToOrderViewModel _addBookModel = new();
    private bool _isLoading = true;
    private bool _isAdding = false;
    private string? _message;
    private bool _isError;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrderData();
    }

    private async Task LoadOrderData()
    {
        _isLoading = true;
        try
        {
            var ordersTask = OrderApi.GetAllOrdersAsync();
            var orderBooksTask = OrderApi.GetOrderBooksAsync(OrderId);
            var booksTask = BookApi.GetAllBooksAsync();

            await Task.WhenAll(ordersTask, orderBooksTask, booksTask);

            var orders = await ordersTask;
            _order = orders.FirstOrDefault(o => o.Id == OrderId);
            _orderBooks = await orderBooksTask;
            
            var allBooks = await booksTask;
            _availableBooks = allBooks.Where(b => b.NumberOfCopies > 0).ToList();
        }
        catch (Exception ex)
        {
            ShowMessage($"Error loading order: {ex.Message}", true);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task AddBook()
    {
        if (_addBookModel.BookId == Guid.Empty)
        {
            ShowMessage("Please select a book.", true);
            return;
        }

        _isAdding = true;
        try
        {
            var (success, errorMessage) = await OrderApi.AddBookToOrderAsync(OrderId, _addBookModel);
            if (success)
            {
                ShowMessage("Book added to order!", false);
                _addBookModel = new AddBookToOrderViewModel();
                await LoadOrderData();
            }
            else
            {
                ShowMessage(errorMessage ?? "Failed to add book.", true);
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"Error: {ex.Message}", true);
        }
        finally
        {
            _isAdding = false;
        }
    }

    private async Task RemoveBook(Guid bookId)
    {
        try
        {
            var success = await OrderApi.RemoveBookFromOrderAsync(OrderId, bookId);
            if (success)
            {
                ShowMessage("Book removed from order.", false);
                await LoadOrderData();
            }
            else
            {
                ShowMessage("Failed to remove book.", true);
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"Error: {ex.Message}", true);
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/orders");
    }

    private void ShowMessage(string message, bool isError)
    {
        _message = message;
        _isError = isError;
    }

    private void ClearMessage()
    {
        _message = null;
    }
}
